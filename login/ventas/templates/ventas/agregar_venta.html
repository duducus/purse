{% extends 'core/base.html' %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Añadir Venta</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('form-venta');
            const buscarButton = document.getElementById('buscar-usuario-btn');
            const codigoUsuarioInput = document.getElementById('codigo-usuario');
            const saldoPuntosInput = document.getElementById('id_pago_puntos');
            const codigoUsuarioHidden = document.getElementById('codigo-usuario-hidden');

            buscarButton.addEventListener('click', function(event) {
                event.preventDefault();
                const codigo = codigoUsuarioInput.value;
                
                // Realiza la búsqueda del usuario por código
                fetch(`/ventas/buscar_usuario/${codigo}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.usuario_encontrado) {
                            form.style.display = 'block';  // Muestra el formulario completo
                            saldoPuntosInput.value = data.saldo_regalo;  // Llena el campo de puntos
                            codigoUsuarioHidden.value = codigo;  // Llena el campo hidden con el código del usuario
                            
                            // Ocultar el campo de código de usuario y el botón de búsqueda
                            codigoUsuarioInput.style.display = 'none';
                            buscarButton.style.display = 'none'; // Oculta el botón de buscar
                        } else {
                            alert('Usuario no encontrado');
                        }
                    });
            });
        });

        // Lógica para actualizar totales del pago
        document.addEventListener('DOMContentLoaded', function() {
            const cantidadInput = document.getElementById('id_cantidad');
            const precioUnitarioInput = document.getElementById('id_precio_unitario');
            const pagoEfectivoInput = document.getElementById('id_pago_efectivo');
            const pagoPuntosInput = document.getElementById('id_pago_puntos');
            const pagoTarjetaInput = document.getElementById('id_pago_tarjeta');
            const totalPagarSpan = document.getElementById('total-pagar');
            const totalRestanteSpan = document.getElementById('total-restante');
            const guardarButton = document.querySelector('button[type="submit"]');

            function updateTotals() {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precioUnitario = parseFloat(precioUnitarioInput.value) || 0;
                const totalPagar = cantidad * precioUnitario;
                totalPagarSpan.textContent = totalPagar.toFixed(2);

                const pagoEfectivo = parseFloat(pagoEfectivoInput.value) || 0;
                const pagoPuntos = parseFloat(pagoPuntosInput.value) || 0;
                const pagoTarjeta = parseFloat(pagoTarjetaInput.value) || 0;
                const totalPagado = pagoEfectivo + pagoPuntos + pagoTarjeta;
                const totalRestante = totalPagar - totalPagado;
                totalRestanteSpan.textContent = totalRestante.toFixed(2);

                if (totalRestante === 0) {
                    guardarButton.disabled = false;
                } else {
                    guardarButton.disabled = true;
                }

                if (totalRestante < 0) {
                    totalRestanteSpan.style.color = 'red';
                    totalRestanteSpan.textContent = 'Exceso de pago';
                    guardarButton.disabled = true;
                } else {
                    totalRestanteSpan.style.color = '';
                }
            }

            cantidadInput.addEventListener('input', updateTotals);
            precioUnitarioInput.addEventListener('input', updateTotals);
            pagoEfectivoInput.addEventListener('input', updateTotals);
            pagoPuntosInput.addEventListener('input', updateTotals);
            pagoTarjetaInput.addEventListener('input', updateTotals);

            updateTotals();
        });
    </script>
</head>
<body>
<div class="container-fluid">
    <h1 class="mb-4">Añadir Nueva Venta</h1>
    
    <!-- Sección de búsqueda de usuario -->
    <div class="mb-4">
        <label for="codigo-usuario">Código de Usuario:</label>
        <input type="text" id="codigo-usuario" class="form-control" placeholder="Ingrese código de usuario">
        <button id="buscar-usuario-btn" class="btn btn-primary mt-2">Buscar Usuario</button>
    </div>

    <!-- Formulario completo, inicialmente oculto -->
    <form id="form-venta" method="post" class="needs-validation" novalidaate style="display: none;">
        {% csrf_token %}
        {{ form.as_p }}

        <!-- Campo oculto para el código de usuario -->
        <input type="hidden" id="codigo-usuario-hidden" name="codigo_usuario">

        <label>Total a pagar: <span id="total-pagar" class="font-weight-bold">0.00</span></label>
        <label>Total restante: <span id="total-restante" class="font-weight-bold">0.00</span></label>
        <button type="submit" class="btn btn-primary" disabled>Guardar</button>
    </form>

    <a href="{% url 'lista_todas_ventas' %}" class="btn btn-link mt-3">Volver a la lista de ventas</a>
</div>
</body>
</html>
{% endblock %}
